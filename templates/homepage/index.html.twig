{% extends 'base.html.twig' %}

{% block title %}Hello TestReactController!{% endblock %}

{% block javascripts %}
    {{ encore_entry_script_tags('app') }}

    <script type="text/javascript">
        let adress = document.querySelector("#merchantform_adress");
        let street = document.querySelector("#merchantform_street");
        let streetnumber = document.querySelector("#merchantform_streetnumber");
        let codepostal = document.querySelector("#merchantform_codepostal");
        let city = document.querySelector("#merchantform_city");
        let cordonneesX = document.querySelector("#merchantform_cordonneX");
        let cordonneesY = document.querySelector("#merchantform_cordonneY");

        var newNode = document.createElement("div");
        newNode.setAttribute("id","autocomplete-list");
        document.body.appendChild(newNode);

        var parentDiv = document.querySelector("#merchantform_street").parentNode;
        var sp2 = document.querySelector("#merchantform_street");
        parentDiv.insertBefore(newNode, sp2);




        function play(){
            const apiUrl = 'https://api-adresse.data.gouv.fr/search/?q=';
            const type = '&type=housenumber';
            const format = '&format=json';

            let code = adress.value;

            code = code.replace(/\s+/g, '+');


            let url = apiUrl + code + type + format;

            return url
        }
        function listeadress(){

            let data = play();
            fetch(data, {methode: 'get'}).then(response => response.json().then(results => {
                const select = document.cereateElement()
            }))

        }
        function dataadress(){
            let data = play();
            fetch(data, {method: 'get'}).then(response => response.json()).then(results => {



                streetnumber.value = results.features[0].properties.housenumber;
                street.value = results.features[0].properties.street;
                codepostal.value = results.features[0].properties.postcode;
                city.value = results.features[0].properties.city
                cordonneesX.value = results.features[0].geometry.coordinates[1];
                cordonneesY.value = results.features[0].geometry.coordinates[0];
            })}

        function listAdress(){

            var searchData = document.querySelector("#merchantform_adress").value;
            adress.onkeydown = function() {
                const h1 = document.createElement('h1');
                let data = play();

                var request = new XMLHttpRequest();
                request.open('GET',data, true);
                request.onload = function () {

                    var data = JSON.parse(this.response);

                    var results = data;
                    if (request.status >= 200 && request.status < 400) {
                        console.log(data);
                        Object.keys(data.features).map(function (key, index) {


                            const searchResultsContainer = document.createElement('div');
                            searchResultsContainer.setAttribute('class', 'row');
                            h1.setAttribute("id","aut");
                            h1.innerHTML = data.features[index].properties.label;
                            h1.innerHTML = data.features[index].properties.label
                            newNode.appendChild(h1);


                        });
                        h1.addEventListener("click", function(e) {
                            console.log(h1);
                            /*insert the value for the autocomplete text field:*/

                            document.querySelector("#merchantform_adress").value = h1.textContent


                            var top = document.querySelectorAll("#aut");
                            var nested = document.querySelector("#autocomplete-list");
                            for (var i=0; i< top.length; i++){
                                var garbage = nested.removeChild(top[i]);
                            }
                        });

                    }}

                request.send();
            }
        }
        adress.addEventListener("keydown",listAdress);
        adress.addEventListener("change",dataadress);
        adress.addEventListener("keyup",dataadress);

        function debounce(callback, delay ){
            let timer = null;
            return function(){
                clearTimeout(timer);
                timer= setTimeout(function(){
                    callback();
                }, delay)
            }
        }
        adress.addEventListener("change", dataadress);
        adress.addEventListener("keyup", debounce(dataadress, 500));
    </script>
{% endblock %}

{% block stylesheets %}
    {{ encore_entry_link_tags('app') }}
{% endblock %}

{% block body %}

    <div class="container-fluid">
        <header class="p-5 d-flex flex  justify-content-between flex-lg-row flex-column text-center">
            <div class="center">
                <img class="header__logo" src="{{ asset('build/images/logo.png') }}">
            </div>
            <h1 class="header__headline pt-3">Mon commerce <span class="negative">à&nbsp;proximité&nbsp;!</span></h1>
        </header>

    </div>

    <div class="container-fluid">
        <div class="col-lg-12 map__container">
            <div id="map" class="py-3"></div>
        </div>
    </div>

    <div class="container form__section">

        <div class="col-lg-12 text-center pt-5">
            <h2>
                Vous êtes commercant ?
            </h2>
            <p>Inscrivez vous ci dessous pour apparaître sur la carte !</p>
        </div>

        <div class="col-lg-8 col-md-12 offset-lg-2 py-5 form__container">
            {{ form_start(merchantForm) }}
            {{ form_rest(merchantForm) }}
            <button type="submit" class="btn btn-block btn-inversed">Valider</button>

            {{ form_end(merchantForm) }}
        </div>
    </div>

    <div class="container-fluid">
        <footer class="p-5 mt-5">
            <div class="row">
                <div class="col-lg-4 col-md-12 text-center">
                    <img class="footer__logo" src="{{ asset('build/images/logo_olfp.png') }}"/>
                </div>
                <div class="col-lg-8 col-md-12 py-5 text-center">
                    <p>Site réalisé bénévolement par la formation<br/><em>"Concepteur Développeur
                            d'applications"</em><br>OnlineFormaPro 2020 - Mulhouse</p>
                    <p>
                        Distribué sous licence<br/>Creative Commons CC-BY-NC-ND<br/>
                        <img class="footer__licence" src="{{ asset('build/images/by-nc-sa.eu.png') }}"/>
                    </p>
                </div>
            </div>

        </footer>

    </div>



{% endblock %}
